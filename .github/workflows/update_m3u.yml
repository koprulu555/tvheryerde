name: ğŸš€ M3U Listesini GÃ¼ncelle

on:
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in
  schedule:
    # 12 saatte bir Ã§alÄ±ÅŸtÄ±r (saat baÅŸÄ± deÄŸil, sÄ±fÄ±rÄ±ncÄ± dakikada)
    - cron: '0 */12 * * *'
  push:
    branches: [ main ]
    paths:
      - 'worker_code.py'  # Sadece bu dosya deÄŸiÅŸirse Ã§alÄ±ÅŸtÄ±r

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ Repository'yi klonla
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Python kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Gerekli paketleri kur
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ğŸ” Workers'tan gÃ¼ncel Python kodunu al
        env:
          WORKERS_URL: 'https://tvheryerde-list.koprulu2.workers.dev/kodlar.txt'
        run: |
          echo "Workers'tan Python kodunu indiriyorum..."
          # Ã–ZEL HEADER: Sadece sizin GitHub'Ä±nÄ±zdan geldiÄŸimizi Workers'a bildir
          curl -s -H "User-Agent: GitHub-Actions-koprulu555" \
               -H "Referer: https://github.com/koprulu555/tvheryerde" \
               "$WORKERS_URL" > worker_code.py
          
          echo "Ä°ndirilen dosya boyutu: $(wc -l < worker_code.py) satÄ±r"
          
          # DosyanÄ±n geÃ§erli Python kodu olup olmadÄ±ÄŸÄ±nÄ± kontrol et
          if head -5 worker_code.py | grep -q "python3"; then
            echo "âœ… GeÃ§erli Python kodu alÄ±ndÄ±"
          else
            echo "âŒ GeÃ§ersiz kod alÄ±ndÄ±! Ä°Ã§erik:"
            head -20 worker_code.py
            exit 1
          fi

      - name: â–¶ï¸ Python kodunu Ã§alÄ±ÅŸtÄ±r (M3U oluÅŸtur)
        id: run_python
        continue-on-error: true
        run: |
          echo "Python kodunu Ã§alÄ±ÅŸtÄ±rÄ±yorum..."
          python worker_code.py
          
          # Ã‡Ä±kÄ±ÅŸ kodunu kontrol et
          PYTHON_EXIT_CODE=$?
          if [ $PYTHON_EXIT_CODE -eq 0 ]; then
            echo "âœ… Python kodu baÅŸarÄ±yla Ã§alÄ±ÅŸtÄ±"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Python kodu hata ile sonlandÄ± (Ã§Ä±kÄ±ÅŸ kodu: $PYTHON_EXIT_CODE)"
            echo "result=failure" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ DeÄŸiÅŸiklikleri kontrol et
        id: check_changes
        if: steps.run_python.outputs.result == 'success'
        run: |
          echo "DeÄŸiÅŸiklikleri kontrol ediyorum..."
          
          # tvheryerde.m3u dosyasÄ±nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
          if [ -f "tvheryerde.m3u" ]; then
            echo "âœ… tvheryerde.m3u dosyasÄ± oluÅŸturuldu"
            
            # DosyayÄ± kontrol et (boÅŸ olmasÄ±n)
            FILE_SIZE=$(wc -c < "tvheryerde.m3u" | tr -d ' ')
            if [ $FILE_SIZE -lt 100 ]; then
              echo "âŒ Dosya Ã§ok kÃ¼Ã§Ã¼k ($FILE_SIZE byte), muhtemelen boÅŸ"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # Ã–nceki commit'teki dosya ile karÅŸÄ±laÅŸtÄ±r
            if git diff --quiet HEAD -- tvheryerde.m3u 2>/dev/null; then
              echo "â„¹ï¸  DeÄŸiÅŸiklik yok (dosya aynÄ±)"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "ğŸ”„ DeÄŸiÅŸiklik tespit edildi"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ tvheryerde.m3u dosyasÄ± bulunamadÄ±!"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ DeÄŸiÅŸiklikleri GitHub'a gÃ¶nder
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "DeÄŸiÅŸiklikleri GitHub'a gÃ¶nderiyorum..."
          
          # Git ayarlarÄ±
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # TÃ¼m dosyalarÄ± ekle
          git add -A
          
          # Commit mesajÄ± oluÅŸtur
          COMMIT_DATE=$(date +"%Y-%m-%d %H:%M:%S")
          COMMIT_MSG="ğŸ”„ M3U listesi gÃ¼ncellendi - $COMMIT_DATE"
          
          # Commit ve push
          git commit -m "$COMMIT_MSG" \
                     -m "â€¢ Otomatik gÃ¼ncelleme tamamlandÄ±" \
                     -m "â€¢ Worker: tvheryerde-list" \
                     -m "â€¢ Ã‡alÄ±ÅŸma: $GITHUB_RUN_ID"
          
          git push
          echo "âœ… DeÄŸiÅŸiklikler GitHub'a gÃ¶nderildi"

      - name: ğŸ Ä°ÅŸlem tamamlandÄ±
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "ğŸ‰ M3U listesi baÅŸarÄ±yla gÃ¼ncellendi ve GitHub'a gÃ¶nderildi"
          else
            echo "â„¹ï¸  DeÄŸiÅŸiklik yok, iÅŸlem tamamlandÄ±"
          fi
          
          # Temizlik (opsiyonel)
          rm -f worker_code.py
