name: ğŸš€ M3U Listesini GÃ¼ncelle

on:
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in
  schedule:
    - cron: '0 */12 * * *'  # 12 saatte bir

jobs:
  update-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ Repository'yi klonla
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Python 3.11 kur
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Gerekli paketi kur (sadece requests)
        run: pip install requests

      - name: ğŸ” Workers'tan Python kodunu indir (Ã–ZEL HEADER Ä°LE)
        env:
          WORKERS_URL: 'https://tvheryerde-list.koprulu2.workers.dev/kodlar.txt'
        run: |
          echo "Workers'tan gizli Python kodunu indiriyorum..."
          # KRÄ°TÄ°K: Workers'Ä±n beklediÄŸi header'larÄ± gÃ¶nderiyoruz
          curl -s -H "User-Agent: GitHub-Actions" \
               -H "Referer: https://github.com/koprulu555/tvheryerde" \
               "$WORKERS_URL" > worker_code.py
          
          echo "Ä°ndirilen kodun ilk satÄ±rlarÄ± kontrol ediliyor..."
          head -5 worker_code.py
          echo "Dosya boyutu: $(wc -l < worker_code.py) satÄ±r"

      - name: â–¶ï¸ Ä°ndirilen Python kodunu Ã§alÄ±ÅŸtÄ±r (M3U oluÅŸtur)
        id: run_python
        continue-on-error: false
        run: |
          echo "Python kodunu Ã§alÄ±ÅŸtÄ±rÄ±yorum..."
          python worker_code.py
          
          # Python Ã§Ä±kÄ±ÅŸ kodunu kontrol et
          if [ $? -eq 0 ]; then
            echo "âœ… Python kodu baÅŸarÄ±yla Ã§alÄ±ÅŸtÄ±"
            echo "python_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Python kodu hata ile sonlandÄ±"
            echo "python_result=failure" >> $GITHUB_OUTPUT
            exit 1  # Bu adÄ±mda hata varsa iÅŸlemi durdur
          fi

      - name: ğŸ“ OluÅŸan M3U dosyasÄ±nÄ± kontrol et
        id: check_file
        if: steps.run_python.outputs.python_result == 'success'
        run: |
          if [ -f "tvheryerde.m3u" ]; then
            FILE_SIZE=$(wc -c < "tvheryerde.m3u" | tr -d ' ')
            if [ $FILE_SIZE -gt 1000 ]; then
              echo "âœ… tvheryerde.m3u dosyasÄ± oluÅŸturuldu. Boyut: $FILE_SIZE byte"
              echo "file_exists=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Dosya oluÅŸtu ama Ã§ok kÃ¼Ã§Ã¼k ($FILE_SIZE byte)."
              echo "file_exists=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ tvheryerde.m3u dosyasÄ± bulunamadÄ±!"
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ DeÄŸiÅŸiklikleri kontrol et ve GitHub'a gÃ¶nder
        if: steps.check_file.outputs.file_exists == 'true'
        run: |
          echo "DeÄŸiÅŸiklikleri kontrol ediyorum..."
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Sadece tvheryerde.m3u dosyasÄ±nÄ± ekle
          git add tvheryerde.m3u
          
          # DeÄŸiÅŸiklik var mÄ± kontrol et
          if git diff --cached --quiet; then
            echo "â„¹ï¸  M3U dosyasÄ±nda deÄŸiÅŸiklik yok, commit atÄ±lmadÄ±."
          else
            COMMIT_TIME=$(date +"%Y-%m-%d %H:%M:%S")
            git commit -m "ğŸ”„ M3U listesi gÃ¼ncellendi" \
                       -m "Otomatik gÃ¼ncelleme: $COMMIT_TIME" \
                       -m "Ã‡alÄ±ÅŸma ID: $GITHUB_RUN_ID"
            
            git push
            echo "âœ… DeÄŸiÅŸiklikler GitHub'a gÃ¶nderildi."
          fi

      - name: ğŸ§¹ GeÃ§ici dosyayÄ± temizle (opsiyonel)
        if: always()
        run: |
          rm -f worker_code.py
          echo "GeÃ§ici dosyalar temizlendi."

      - name: ğŸ Ä°ÅŸlem tamamlandÄ±
        run: |
          if [ "${{ steps.check_file.outputs.file_exists }}" = "true" ]; then
            echo "ğŸ‰ M3U gÃ¼ncelleme iÅŸlemi baÅŸarÄ±yla tamamlandÄ±!"
          else
            echo "â„¹ï¸  Ä°ÅŸlem tamamlandÄ± (M3U dosyasÄ± oluÅŸturulamadÄ± veya deÄŸiÅŸiklik yoktu)."
          fi
